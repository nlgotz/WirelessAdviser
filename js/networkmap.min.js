function initialize(){var e={zoom:defaultZoom,mapTypeId:google.maps.MapTypeId.TERRAIN};map=new google.maps.Map(document.getElementById("map_canvas"),e);bounds=new google.maps.LatLngBounds}function updateSeverityCircles(){log.info("networkmap.js: updateSeverityCircles called.");for(var e in deviceMarkerMap){var t=deviceMarkerMap[e];var n=deviceSeverityCircleMap[t.id];if(n!=null){n.setMap(null)}var r=getColorForSeverityId(t.severity_id);var i=t.position;var s=zoomToRadiusMap[map.getZoom()]*radiusScale;log.info("networkmap.js created severity circle for "+t.id+", color: "+r+", center: "+i+", radius: "+s);statusCircle=new google.maps.Circle({fillColor:r,fillOpacity:.5,center:i,radius:s,strokeColor:r,strokeWeight:1});deviceSeverityCircleMap[t.id]=statusCircle;statusCircle.setMap(map)}}function loadMarkers(){log.info("networkmap.js: loading map markers.");var e=map.getZoom();var t=map.getBounds();$.ajax({url:networkMapUrl,cache:false,success:function(e){log.info("networkmap.js: json data received: "+e);if(e.indexOf("ERROR")!=-1){document.getElementById("map_canvas").innerHTML="Error getting device and mapping data from the database.";return}var t=jQuery.parseJSON(e);log.info("networkmap.js: json data parsed: "+t);var n=[];for(index in t.deviceList){var r=new Object;r.device_id=t.deviceList[index].device_id;r.display_name=t.deviceList[index].display_name;r.device_type=t.deviceList[index].device_type;r.severity_id=t.deviceList[index].severity_id;r.device_state=t.deviceList[index].device_state;if(r.severity_id.length==0||r.device_state=="unknown"){r.severity_id=.5}r.point=new google.maps.LatLng(parseFloat(t.deviceList[index].latitude),parseFloat(t.deviceList[index].longitude));deviceLatLngMap[r.device_id]=r.point;if(typeof n[r.point]==="undefined"){n[r.point]=new Array}n[r.point].push(r);deviceSeverityMap[r.device_id]=r.severity_id}for(point in n){if(n[point].length>1){log.info("networkmap.js: cluster of "+n[point].length+" detected at point "+point);var i="";var s="";var o="";var u="<b>Devices at this Cluster:</b><hr>";u+="<table>";var a=0;for(index in n[point]){var r=n[point][index];i+=r.device_id+":";s+=r.display_name+", ";o=r.point;var f=getColorForSeverityId(r.severity_id);u+='<tr><td style="background-color:'+f+'">   </td>';u+='<td><img src="images/'+r.device_type+'.png" height="24" width="24"/></td>';u+='<td><a href="#" onclick="launchDeviceSheet(\''+r.device_id+"', '"+r.device_type+".php');\">"+r.display_name+"</a></td></tr>";if(a<r.severity_id){a=r.severity_id}}u+="</table>";i=i.substring(0,i.length-1);s=s.substring(0,s.length-2);log.info("networkmap.js: created cluster "+i+" with severity "+a);var l=getIconForMarker("Cluster");var c=new google.maps.Marker({position:o,icon:l,title:s,type:"Cluster",severity_id:a,id:i,infoTextContent:u,optimized:!(jQuery.browser.msie&&jQuery.browser.version<9)});var h=new google.maps.InfoWindow;bindInfoW(c,this.infoTextContent,h);google.maps.event.addListener(c,"click",function(){h.content=this.infoTextContent;h.open(map,this)});var p=deviceMarkerMap[i];if(p!=null){p.setMap(null)}deviceMarkerMap[i]=c;c.setMap(map);bounds.extend(c.position)}else{var r=n[point][0];log.info("networkmap.js creating marker for non-clustered device "+r.device_id);var l=getIconForMarker(r.device_type);var c=new google.maps.Marker({position:r.point,icon:l,title:r.display_name,type:r.device_type,page:r.device_type+".php",severity_id:r.severity_id,id:r.device_id,optimized:!(jQuery.browser.msie&&jQuery.browser.version<9)});google.maps.event.addListener(c,"click",function(){launchDeviceSheet(this.id,this.page);if(event.stopPropagation){event.stopPropagation()}else if(window.event){window.event.cancelBubble=true}});var p=deviceMarkerMap[r.device_id];if(p!=null){p.setMap(null)}deviceMarkerMap[r.device_id]=c;c.setMap(map);bounds.extend(c.position)}}if(initialMapLoad==true){map.fitBounds(bounds);initialMapLoad=false}log.info("networkmap.js: markers loaded.");loadLinks()}})}function loadLinks(){log.info("networkmap.js: loading links.");$.ajax({url:networkLinksUrl,cache:false,success:function(e){log.info("networkmap.js: json data received: "+e);if(e.indexOf("ERROR")!=-1){document.getElementById("map_canvas").innerHTML="Error getting link data from the database.";return}var t=jQuery.parseJSON(e);log.info("networkmap.js: json data parsed: "+t);for(index in t.linkList){var n=t.linkList[index].parent_id;var r=t.linkList[index].child_id;var i=n+":"+r;if(n in deviceLatLngMap==false||r in deviceLatLngMap==false){continue}var s=deviceLatLngMap[n];var o=deviceLatLngMap[r];var u=[s,o];var a=deviceSeverityMap[n];if(deviceSeverityMap[r]>a){a=deviceSeverityMap[r]}var f=getColorForSeverityId(a);log.debug("networkmap.js: parent severity: "+deviceSeverityMap[n]+", child severity: "+deviceSeverityMap[r]+", overall severity: "+a+" Link color: "+f);log.info("networkmap.js: linking "+n+"->"+r+":"+getNameForSeverityId(a)+"("+f+")");var l=new google.maps.Polyline({path:u,strokeColor:f,strokeOpacity:1,strokeWeight:2,id:i});var c=deviceLinkMap[i];if(c!=null){c.setMap(null)}deviceLinkMap[i]=l;l.setMap(map)}log.info("networkmap.js: links loaded.")}})}function getIconForMarker(e){var t="images/"+e+".png";var n=new google.maps.Size(23,24);var r=new google.maps.MarkerImage(t,n,null,new google.maps.Point(12,12),n);return r}function refreshNetworkMap(){loadMarkers();updateSeverityCircles()}function bindInfoW(e,t,n){google.maps.event.addListener(e,"click",function(){n.setContent(t);n.open(map,e)})}var map;var bounds;var mapHeight="575px";var mapWidth="800px";var networkMapUrl="model/getdevicesformap.php";var networkLinksUrl="model/getlinksformap.php";var deviceLatLngMap=[];var deviceMarkerMap=[];var deviceSeverityMap=[];var deviceSeverityCircleMap=[];var deviceLinkMap=[];var zoomToRadiusMap=[32768,16384,8192,4096,2048,1024,512,256,128,64,32,16,8,4,2,1];var radiusScale=50;var infoWindowHeight=600;var infoWindowWidth=200;var mapRefreshInterval=2;var defaultZoom=9;var initialMapLoad=true;$(document).ready(function(){$("#showMap").click(function(){refreshNetworkMap()});initialize();refreshNetworkMap();google.maps.event.addListener(map,"zoom_changed",updateSeverityCircles);setInterval(function(){refreshNetworkMap();log.info("networkmap.js: refreshed map view")},mapRefreshInterval*6e4)})